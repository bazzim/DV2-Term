---
title: "European Energy"
author: "Mariam Bazzi"
date: "4/4/2021"
output:
  html_document:
    df_print: paged
  html_notebook:
    code_folding: hide
---
For this project, I chose the European Energy datasets to explore and analyze the types and amounts of energy generated in European countries.

### [GitHub repo](https://github.com/bazzim/DV2-Term.git)

### Loading and cleaning data
First, lets load the datasets and do some cleaning to it. Both datasets include information on how much of electricity each European country generated between 2016-2018 and the types of energies generated.

```{r message=FALSE, class.source = "fold-show"}
# load packages
library(tidyverse)
library(scales)
library(magrittr)
require(tidytext)
library(tidytext)
library(gganimate)
library(maps)
library(viridis)
require(transformr)
# load datasets
energy_types = read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-08-04/energy_types.csv')
export_info = read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-08-04/country_totals.csv')
```
```{r class.source = "fold-show"}
# Fill in country name by country code
energy_types$country_name[energy_types$country == 'UK'] = 'UK'
export_info$country_name[export_info$country == 'UK'] = 'UK'
```
There are a few missing values in "country_name" column for the UK, and some countries have wrong ISO code. So lets also fix that..
```{r class.source = "fold-show"}
# fix ISO codes
energy_types$country[energy_types$country_name == 'Greece'] = 'GR'
energy_types$country[energy_types$country_name == 'Great Britain'] = 'GB'
export_info$country[export_info$country_name == 'Greece'] = 'GR'
export_info$country[export_info$country_name == 'Great Britain'] = 'GB'
```
Next, I will impute the missing values with value from the succeeding year to handle the missing values. The dataset needs to be tidy, where each observation is represented on a single row, so lets do that.
```{r class.source = "fold-show"}
# impute NA with value from succeeding year
export_info$`2016` = ifelse(is.na(export_info$`2016`), export_info$`2017`, export_info$`2016`)
```

```{r class.source = "fold-show"}
# pivot tables
energy_types %<>%
    pivot_longer(names_to = 'year', values_to = 'GWh', cols = starts_with('2')) %>%
    mutate(year = as.integer(year))

export_info %<>%
    pivot_longer(names_to = 'year', values_to = 'GWh', cols = starts_with('2')) %>%
    mutate(year = as.integer(year))
```


### Energy types
What types of generated energy are there?
```{r}
energy_types %>%
  mutate(type = fct_reorder(type, GWh, sum)) %>%
  ggplot() +
    geom_col(aes(type, GWh, fill = type)) +
    coord_flip() +
    theme(legend.position = 'none') +
    ylab('Energy produced [GWh]') + xlab('') +
    scale_y_continuous(label=comma) +
    transition_states(year) +
    labs(title = 'Year: {closest_state}')
```
We have 7 types of energy plus an "other" category (which contains almost zero amount of energy). Pumped hydro power is subset of Hydro, so 6 basic types.


For a start, we'll take a look at the types and amounts of enegy generated by each country:
```{r}
energy_types %>%
        filter(level == 'Level 1') %>%
        filter(type != 'Other') %>%
        mutate(country_name = fct_reorder(country_name, GWh, sum)) %>%
        mutate(type = fct_reorder(type, GWh, sum),
               country_name = fct_lump(country_name, 11, w=GWh)) %>%
        ggplot() +
            geom_col(aes(country_name, GWh, fill = type)) +
            coord_flip() +
            ylab('Energy generated [GWh]') + xlab('Country') +
            scale_y_continuous(label=comma) +
            scale_fill_manual(values=c('black', 'orange', '#00AA00', '#0000BB', '#888888', '#CC0000')) +
                transition_states(year) +
                labs(title = 'Year: {closest_state}')
```
According to the plot above, France is ranked second based on total amount of generated energy, and it produces mostly nuclear energy, which is clean. Germany is the largest generator; approximately 60% of it is conventional thermal.
UK, Italy, Turkey, Poland, Netherlands also generating a lot of conventional thermal energy. Norway mainly uses hydro generators. Sweden also produces only renweable energy.

We can look at this based on the type of generated energy:
```{r echo=T, eval=T, knitr=F}
energy_types %>%
    filter(level == 'Level 1', GWh > 0, type != 'Other') %>%
    group_by(type) %>%
    mutate(country_name = fct_lump(country_name, 5, w=GWh),
           country = fct_lump(country, 5, w=GWh),
           type = fct_reorder(type, GWh, sum),
           country_name = reorder_within(country_name, GWh, type, fun=sum)
           ) %>%
    filter(country != 'Other') %>%
    ggplot(aes(GWh, country_name, fill=country)) +
        geom_col() +
        scale_y_reordered() +
        xlab('Energy of specific type, generated by country [GWh]') + ylab('') +
        facet_wrap(~type, scale='free', ncol=2) +
        theme(legend.position = 'none') +
        scale_x_continuous(label=comma) +
        transition_states(year) +
        labs(title = 'Year: {closest_state}')
```
From this point of view, Germany not only generates a lot of conventional thermal energy, but also generates solar and wind energy the most compared to other countries.


### Renewable Energy
Now we will look at the proportion of generated clean energy and its dynamic.
```{r, message=F}
energy_types$is_clean = 'Clean'   # Conventional thermal isn't clean type of energy and others are.
energy_types$is_clean[energy_types$type == 'Conventional thermal'] = 'Conventional thermal'

energy_types %>%
        group_by(year, is_clean) %>%
        summarise(total = sum(GWh)) %>%
        ggplot() +
            geom_col(aes(year, total, fill=is_clean), position='dodge') +
            scale_fill_manual(values = c('#197419', '#CC1111')) +
            xlab('Year') + ylab('Total energy generated by Europe [GWh]') +
            labs(fill='Type of energy') +
            scale_y_continuous(label=comma)
```
In 2018, there was an increase in clean energy production and less conventional thermal energy production compared to 2016. But which countries drive this changes?
```{r, warning=F}
energy_types %>%
        group_by(country_name, year) %>%
        mutate(total = sum(GWh),
               percent_clean = ifelse(type == 'Conventional thermal', 1 - GWh/total, -1)) %>%
        filter(total > 100000, percent_clean != -1,
               year != 2017) %>%

        ggplot(aes(year, percent_clean)) +
            geom_line(aes(group = country_name, color = country_name), size=1.5) +
            geom_text(aes(label = ifelse(year == 2017, NA, country_name),
                          hjust = ifelse(year == 2016, 1.2, -.2)),
                        check_overlap = T) +
            scale_x_continuous(breaks = c(2016, 2018), limits = c(2015, 2019)) +
            scale_y_continuous(labels=scales::percent_format(accuracy=10)) +
            theme(panel.grid = element_blank()) +
            xlab('Year') + ylab('Percent of clean energy')
```
Germany, United Kingdom, Ukraine and Netherlands (also Italy and France a bit) raised percent of clean energy among all generated energy. Other countries, those who generating significant amount of energy, had almost equal percent in 2016 and 2018. Spain had a little fall.

Here is a summary which shows the proportions of energy generated by every country, is clean.
```{r fig.height=11, fig.width = 10, message=F}
country_list = unique(energy_types$country_name)
map = map_data("world", region = country_list)

for_map = energy_types %>%
  group_by(country_name, year, is_clean) %>%
  summarise(GWh = sum(GWh)) %>%
  pivot_wider(names_from=is_clean, values_from=GWh) %>%
  rename(Conventional_thermal = 'Conventional thermal') %>%
  mutate(clean_rate = Clean / (Clean + Conventional_thermal)) %>%
  mutate(region = country_name)

exports_map = left_join(map, for_map, by='region')

# Computing the centroid as the mean longitude and latitude
# Used as label coordinate for country's names
region.lab.data = map %>%
  group_by(region) %>%
  summarise(long = mean(long), lat = mean(lat))

mid_point = sum(for_map$Clean / (sum(for_map$Clean) + sum(for_map$Conventional_thermal)))
ggplot(exports_map, aes(x = long, y = lat)) +
  geom_polygon(aes( group = group, fill = clean_rate), color='yellow')+
  geom_text(aes(label = region), data = region.lab.data,  size = 4, hjust = 0.5)+
  labs(fill = '% of clean energy') +
  theme_void() +
  scale_fill_gradient2(low='#FF0000', midpoint=mid_point, mid='white', high='#197419') +
  theme(axis.title.x = element_blank(),
        plot.caption = element_text(size = 16, hjust = 0.5, face = "bold")) +
    transition_states(year) +
    labs(caption = 'Year: {closest_state}')
```

### Exports and imports

Which countries are generating energy for export? If so, what are the amount of exported energy?

```{r}
export_info %>%
    mutate(type = fct_reorder(type, GWh, sum)) %>%
    ggplot(aes(type, GWh)) +
        geom_col(aes(fill = type)) +
        coord_flip() +
        theme(legend.position = 'none') +
        ylab('Amount of energy [GWh]') + xlab('') +
        scale_y_continuous(label=comma) +
            transition_states(year) +
            labs(title = 'Year: {closest_state}')
```
Well, it seems like most of energy was produced for supply that country itself, but still there is some export, so lets look closely at this. There is countries with the most amount of export:
```{r}
export_info %>%
  mutate(type = ifelse(type == 'Total net production', 'total_production', type)) %>%
  pivot_wider(names_from=type, values_from=GWh) %>%
  mutate(country_name = fct_lump(country_name, 4, w=Exports)) %>%
  filter(country_name != 'Other') %>%
  mutate(country_name = fct_reorder(country_name, Exports)) %>%
  pivot_longer(names_to='type', values_to='GWh', cols=c('total_production', 'Imports', 'Exports', 'Energy absorbed by pumping', 'Energy supplied' )) %>%
  filter(type == 'total_production' | type == 'Exports' | type == 'Imports') %>%
  filter(country_name != 'Other') %>%
  mutate(type = ifelse(type == 'total_production', 'Total net production', type)) %>%
  mutate(type = fct_reorder(type, GWh)) %>%
    ggplot() +
        geom_col(aes(country_name, GWh, fill = type), position = 'dodge') +
        coord_flip() +
        scale_y_continuous(labels=comma) +
        xlab('') + ylab('Amount of energy [GWh]') +
        labs(fill='')
```
Export is holding some percent of energy, generated by that countries, though its not a large proportion.

In the plot below, orange countries represent exporters of energy, and blue countries represent importers
```{r fig.height=11, fig.width = 10}
country_list = unique(energy_types$country_name)
map = map_data("world", region = country_list)

for_map = export_info %>%
  pivot_wider(names_from=type, values_from=GWh) %>%
  mutate(difference = Exports - Imports) %>%
  mutate(region = country_name)

exports_map = left_join(map, for_map, by='region')

# Computing the centroid as the mean longitude and lattitude
# Used as label coordinate for country's names
region.lab.data = map %>%
  group_by(region) %>%
  summarise(long = mean(long), lat = mean(lat))

ggplot(exports_map, aes(x = long, y = lat)) +
  geom_polygon(aes( group = group, fill = difference), color='yellow')+
  geom_text(aes(label = region), data = region.lab.data,  size = 4, hjust = 0.5)+
  labs(fill = 'Difference between \nexport and import') +
  theme_void() +
  scale_fill_gradient2(low='#0000BB', midpoint=0, mid='white', high='#FFE500')+
    theme(axis.title.x = element_blank(),
          plot.caption = element_text(size = 16, hjust = 0.5, face = "bold")) +
    transition_states(year) +
    labs(caption = 'Year: {closest_state}')
```

This gives us some insights of the structure of energy generated in Europe between 2016 and 2018, and how it changes throughout these couple of years. Eco-friendly generators are slowly taking over in most countries.


